From 16804e0f770e7e48a3caced3f5437f034fce9d7b Mon Sep 17 00:00:00 2001
From: "Standing-StormStanding-Storm git config --global user.name
 Standing-Storm git config --global user.name Standing-Storm"
 <dorchadas@gmail.com>
Date: Sun, 10 Sep 2023 21:18:32 -0500
Subject: [PATCH 1/2] Fix issues

---
 data/mods/Magiclysm/Spells/druid.json         |  46 ++++++-
 data/mods/Magiclysm/effects/effects.json      | 119 ++++++++++++++++--
 data/mods/Magiclysm/emitter.json              |  16 +++
 data/mods/Magiclysm/field.json                |  30 +++++
 .../mods/Magiclysm/itemgroups/itemgroups.json |   2 +-
 5 files changed, 193 insertions(+), 20 deletions(-)

diff --git a/data/mods/Magiclysm/Spells/druid.json b/data/mods/Magiclysm/Spells/druid.json
index d20c9526f0a24..40a6c7f4449bf 100644
--- a/data/mods/Magiclysm/Spells/druid.json
+++ b/data/mods/Magiclysm/Spells/druid.json
@@ -520,10 +520,10 @@
     "id": "druid_natures_commune",
     "type": "SPELL",
     "name": "Nature's Commune",
-    "description": "You concentrate on the nature around you and commune with it, improving your health and calming the nearby wildlife.",
+    "description": "You concentrate on the nature around you and commune with it, improving your health and calming the nearby wildlife.  This spell may only be cast outdoors.",
     "valid_targets": [ "self" ],
-    "effect": "attack",
-    "effect_str": "natures_commune",
+    "effect": "effect_on_condition",
+    "effect_str": "EOC_NATURE_COMMUNE",
     "shape": "blast",
     "flags": [ "CONCENTRATE", "SOMATIC", "VERBAL", "NO_LEGS", "NO_HANDS" ],
     "energy_source": "MANA",
@@ -534,9 +534,43 @@
     "final_energy_cost": 400,
     "energy_increment": 10,
     "max_level": 20,
-    "min_duration": 10000,
-    "max_duration": 40000,
-    "duration_increment": 2000
+    "min_duration": 30000,
+    "max_duration": 360000,
+    "duration_increment": 16500
+  },
+  {
+    "type": "effect_on_condition",
+    "id": "EOC_NATURE_COMMUNE",
+    "condition": {
+      "and": [
+        "u_is_outside",
+        { "not": { "u_near_om_location": "road_curved", "range": 1 } },
+        { "not": { "u_near_om_location": "road_four_way", "range": 1 } },
+        { "not": { "u_near_om_location": "road_tee", "range": 1 } },
+        { "not": { "u_near_om_location": "road_straight", "range": 1 } },
+        { "not": { "u_near_om_location": "road_end", "range": 1 } },
+        { "not": { "u_near_om_location": "road_sw", "range": 1 } },
+        { "not": { "u_near_om_location": "road_ne", "range": 1 } },
+        { "not": { "u_near_om_location": "road_ew", "range": 1 } },
+        { "not": { "u_near_om_location": "road_ns", "range": 1 } },
+        { "not": { "u_near_om_location": "road_nesw", "range": 1 } },
+        { "not": { "u_near_om_location": "road", "range": 1 } }
+      ]
+    },
+    "effect": [
+      {
+        "u_add_effect": "natures_commune",
+        "duration": { "math": [ "( 300 + (u_val('spell_level', 'spell: druid_natures_commune') * 165)) " ] }
+      },
+      {
+        "u_add_morale": "morale_forest_unity",
+        "bonus": 10,
+        "max_bonus": 15,
+        "duration": { "math": [ "( 300 + (u_val('spell_level', 'spell: druid_natures_commune') * 165) )" ] },
+        "decay_start": { "math": [ "(( 300 + (u_val('spell_level', 'spell: druid_natures_commune') * 165) ) / 2)" ] }
+      }
+    ],
+    "false_effect": [ { "u_message": "You must be surrounded by nature to commune with nature", "type": "bad" } ]
   },
   {
     "id": "druid_growth",
diff --git a/data/mods/Magiclysm/effects/effects.json b/data/mods/Magiclysm/effects/effects.json
index 2c9f0ee7dcd2b..adc1dfc1edbc8 100644
--- a/data/mods/Magiclysm/effects/effects.json
+++ b/data/mods/Magiclysm/effects/effects.json
@@ -380,11 +380,10 @@
     "name": [ "Nature's Commune" ],
     "desc": [ "You can feel Mother Nature welcoming you, revitalizing your body and calming the natural fauna around you." ],
     "apply_message": "A warm embrace surrounds you, like that of a mother with her child.",
-    "remove_message": "Your commune with Mother Nature fades.",
+    "remove_message": "Your communion with Mother Nature fades.",
     "rating": "good",
-    "max_duration": "20 m",
-    "//": "No morale_mod is currently possible in effects, but this effect should give +5/+10 morale whenever that it's implemented.",
-    "base_mods": { "health_min": [ 1 ], "health_chance": [ 40 ], "h_mod_min": [ 1 ], "h_mod_chance": [ 80 ] }
+    "max_duration": "120 m",
+    "base_mods": { "health_min": [ 1 ], "health_chance": [ 40 ], "h_mod_min": [ 1 ], "h_mod_chance": [ 80 ], "health_tick": [ 30 ] }
   },
   {
     "type": "effect_type",
@@ -503,18 +502,12 @@
     "id": "electric_waves",
     "type": "effect_type",
     "name": [ "Electric Waves" ],
-    "desc": [ "Your body throw a massive electric charges when you attack monsters." ],
+    "desc": [ "Your body will release a massive electric charges when you attack monsters." ],
     "apply_message": "A powerful energy streams out of your hands.",
-    "remove_message": "Energy streams calm down.",
+    "remove_message": "The energy streams calm down.",
     "rating": "good",
     "show_intensity": false,
-    "//": "When #61693 will be resolved (or, in other words, the spell will start to throw electric waves, as it says), the ITEM_DAMAGE_ELEC must be removed, and the spell description must be edited.  Alternatively, the effect may be moved into electric gloves, instead of their flat bonus.",
-    "enchantments": [
-      {
-        "hit_me_effect": [ { "id": "electric_waves_damage", "once_in": 3 } ],
-        "values": [ { "value": "ITEM_DAMAGE_ELEC", "add": { "u_val": "spell_level", "spell": "electric_waves" } } ]
-      }
-    ]
+    "enchantments": [ "enchant_stormshaper_electric_waves" ]
   },
   {
     "id": "electric_arts",
@@ -730,6 +723,106 @@
       }
     ]
   },
+  {
+    "type": "effect_type",
+    "id": "effect_sense_outsiders",
+    "name": [ "Sense Outsider" ],
+    "desc": [ "You can sense the presence of things that should not be." ],
+    "apply_message": "",
+    "remove_message": "Your awareness of outsiders fades.",
+    "rating": "good",
+    "enchantments": [
+      {
+        "values": [
+          {
+            "value": "SIGHT_RANGE_NETHER",
+            "add": { "math": [ "(( u_val('spell_level', 'spell: animist_sense_outsiders') * 2.5) + 3)" ] }
+          }
+        ]
+      }
+    ]
+  },
+  {
+    "type": "effect_type",
+    "id": "effect_kelvinist_anti_cold",
+    "name": [ "Cloak of Warmth" ],
+    "desc": [ "The air around you is warmer thanks to your magic." ],
+    "apply_message": "",
+    "remove_message": "A cool breeze hits your skin.",
+    "rating": "good",
+    "enchantments": [
+      {
+        "emitter": "emit_kelvinist_anti_cold",
+        "values": [
+          { "value": "CLIMATE_CONTROL_HEAT", "add": 50 },
+          {
+            "value": "ARMOR_COLD",
+            "add": { "math": [ "( u_val('spell_level', 'spell: kelvinist_anti_cold') * -1)" ] }
+          }
+        ]
+      }
+    ]
+  },
+  {
+    "type": "effect_type",
+    "id": "effect_kelvinist_anti_heat",
+    "name": [ "Cloak of Chill" ],
+    "desc": [ "The air around you is cooler thanks to your magic." ],
+    "apply_message": "",
+    "remove_message": "A warm breeze hits your skin.",
+    "rating": "good",
+    "enchantments": [
+      {
+        "emitter": "emit_kelvinist_anti_heat",
+        "values": [
+          { "value": "CLIMATE_CONTROL_CHILL", "add": 50 },
+          {
+            "value": "ARMOR_HEAT",
+            "add": { "math": [ "( u_val('spell_level', 'spell: kelvinist_anti_heat') * -1)" ] }
+          }
+        ]
+      }
+    ]
+  },
+  {
+    "type": "effect_type",
+    "id": "effect_magus_slowfall",
+    "name": [ "Slowfall" ],
+    "desc": [ "You won't hit the ground nearly as hard anymore." ],
+    "apply_message": "",
+    "remove_message": "You can feel gravity take hold of you again.",
+    "enchantments": [
+      {
+        "values": [
+          {
+            "value": "FALL_DAMAGE",
+            "multiply": { "math": [ "(( u_val('spell_level', 'spell: magus_slowfall') * -0.01) - 0.9 )" ] }
+          }
+        ]
+      }
+    ]
+  },
+  {
+    "type": "effect_type",
+    "id": "effect_magus_spiderclimb",
+    "name": [ "Spider Climb" ],
+    "desc": [ "You can quickly ascend sheer surfaces." ],
+    "apply_message": "",
+    "remove_message": "Your enhanced climbing ability vanishes.",
+    "flags": [ "CLIMB_NO_LADDER", "WALL_CLING" ]
+  },
+  {
+    "type": "effect_type",
+    "id": "effect_biomancer_swim_speed",
+    "name": [ "Frog Limbs" ],
+    "desc": [ "Your hands and feet have grown webbing, enabling faster swimming." ],
+    "//": "Minor stamina regen to help with swimming.  If people want to cast this spell as a stamina buff, they're welcome to do it and deal with their froggy limbs.",
+    "apply_message": "",
+    "remove_message": "With an unpleasant twisting sensation your hands and feet return to normal.",
+    "rating": "good",
+    "flags": [ "WEBBED_HANDS", "WEBBED_FEET" ],
+    "base_mods": { "stamina_min": [ 10 ] }
+  },
   {
     "id": "effect_biomancer_remove_instability",
     "type": "effect_type",
diff --git a/data/mods/Magiclysm/emitter.json b/data/mods/Magiclysm/emitter.json
index cd724ce8b11b1..887d69eab075d 100644
--- a/data/mods/Magiclysm/emitter.json
+++ b/data/mods/Magiclysm/emitter.json
@@ -52,6 +52,22 @@
     "qty": 22,
     "chance": 100
   },
+  {
+    "id": "emit_kelvinist_anti_heat",
+    "type": "emit",
+    "field": "fd_kelvinist_cold",
+    "intensity": 3,
+    "qty": 300,
+    "chance": 100
+  },
+  {
+    "id": "emit_kelvinist_anti_cold",
+    "type": "emit",
+    "field": "fd_kelvinist_warmth",
+    "intensity": 3,
+    "qty": 300,
+    "chance": 100
+  },
   {
     "id": "emit_rad_mage",
     "type": "emit",
diff --git a/data/mods/Magiclysm/field.json b/data/mods/Magiclysm/field.json
index ae879e9fe2dcc..50f6a44875762 100644
--- a/data/mods/Magiclysm/field.json
+++ b/data/mods/Magiclysm/field.json
@@ -140,6 +140,36 @@
     "half_life": "999999999 minutes",
     "looks_like": "fd_fog"
   },
+  {
+    "id": "fd_kelvinist_warmth",
+    "type": "field_type",
+    "intensity_levels": [
+      { "name": "heated air", "sym": "&", "convection_temperature_mod": 7 },
+      { "color": "yellow", "convection_temperature_mod": 15 },
+      { "color": "red", "convection_temperature_mod": 30 }
+    ],
+    "decay_amount_factor": 5,
+    "percent_spread": 50,
+    "outdoor_age_speedup": "15 minutes",
+    "priority": 7,
+    "half_life": "30 minutes",
+    "phase": "gas"
+  },
+  {
+    "id": "fd_kelvinist_cold",
+    "type": "field_type",
+    "intensity_levels": [
+      { "name": "chill air", "sym": "&", "convection_temperature_mod": -7 },
+      { "color": "blue", "convection_temperature_mod": -15 },
+      { "color": "cyan", "convection_temperature_mod": -30 }
+    ],
+    "decay_amount_factor": 5,
+    "percent_spread": 50,
+    "outdoor_age_speedup": "15 minutes",
+    "priority": 7,
+    "half_life": "30 minutes",
+    "phase": "gas"
+  },
   {
     "id": "fd_rad_mage_aura",
     "type": "field_type",
diff --git a/data/mods/Magiclysm/itemgroups/itemgroups.json b/data/mods/Magiclysm/itemgroups/itemgroups.json
index 52a30dca71498..79b0dd188a047 100644
--- a/data/mods/Magiclysm/itemgroups/itemgroups.json
+++ b/data/mods/Magiclysm/itemgroups/itemgroups.json
@@ -21,7 +21,7 @@
     "type": "item_group",
     "id": "homebooks",
     "copy-from": "homebooks",
-    "extend": { "items": [ { "group": "spellbook_loot_0", "prob": 4 } ] }
+    "extend": { "items": [ { "group": "spellbook_loot_0", "prob": 4 }, { "item": "history_botanical_enchantment", "prob": 2 } ] }
   },
   {
     "type": "item_group",

From 53792189b6a60125c1b0dd3a88d6e0d97437eec3 Mon Sep 17 00:00:00 2001
From: "Standing-StormStanding-Storm git config --global user.name
 Standing-Storm git config --global user.name Standing-Storm"
 <dorchadas@gmail.com>
Date: Sun, 10 Sep 2023 21:25:39 -0500
Subject: [PATCH 2/2] Cloak of Warmth and Cloak of Chill cancel the other one

---
 data/mods/Magiclysm/effects/effects.json | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/data/mods/Magiclysm/effects/effects.json b/data/mods/Magiclysm/effects/effects.json
index adc1dfc1edbc8..c4d9487e28b82 100644
--- a/data/mods/Magiclysm/effects/effects.json
+++ b/data/mods/Magiclysm/effects/effects.json
@@ -750,6 +750,7 @@
     "apply_message": "",
     "remove_message": "A cool breeze hits your skin.",
     "rating": "good",
+    "removes_effects": [ "effect_kelvinist_anti_heat" ],
     "enchantments": [
       {
         "emitter": "emit_kelvinist_anti_cold",
@@ -771,6 +772,7 @@
     "apply_message": "",
     "remove_message": "A warm breeze hits your skin.",
     "rating": "good",
+    "removes_effects": [ "effect_kelvinist_anti_cold" ],
     "enchantments": [
       {
         "emitter": "emit_kelvinist_anti_heat",
